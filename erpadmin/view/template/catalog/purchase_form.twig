{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="float-end">
        <button type="submit" id="purchase_save_btn" form="form-purchase" data-bs-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i></button>
        <a href="{{ back }}" data-bs-toggle="tooltip" title="{{ button_back }}" class="btn btn-light"><i class="fa-solid fa-reply"></i></a></div>
      <h1>Purchase</h1>
      <ol class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
          <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ol>
    </div>
  </div>
  <div class="container-fluid">
    <div class="card">
      <div class="card-header"><i class="fa-solid fa-pencil"></i> {{ text_form }}</div>
      <div class="card-body">
        <form id="form-purchase" action="{{ action }}" method="post" data-oc-toggle="ajax">
            <div class="row mb-3" id="input-vendor-class-main">
              <label class="col-sm-1 col-form-label">Vendor</label>
              <div class="col-sm-11">
                  <div class="input-group">
                   <select name="vendor_id" id="input-vendor-class" class="form-select">
                        <option value="0">None</option>
                        {% for vendor in vendors %}
                          <option value="{{ vendor.vendor_id }}"{% if vendor.vendor_id == vendor_id %} selected{% endif %}>{{ vendor.name }}</option>
                        {% endfor %}
                      </select>
                  </div>
              </div>
            </div>
            <div class="row mb-3" id="input-search-class-main">
              <label class="col-sm-1 col-form-label">Product List</label>
              <div class="col-sm-11">
                <div class="input-group">
                  <select name="product_id[]" multiple id="product_id" class="form-select">
                    {% for data in datas %}
                      <option value="{{ data.product_ids }}"{% if data.product_ids in product_id %} selected{% endif %}>{{ data.name }}</option>
                    {% endfor %}
                  </select>
               </div>
              </div>
            </div>
            <div class="row mb-3">
              <label for="input-filename" class="col-sm-1 col-form-label">Purchase Invoice</label>
              <div class="col-sm-11">
                <div class="input-group">
                  <button type="button" id="button-upload" class="btn btn-primary"><i class="fa-solid fa-upload"></i> Upload</button>
                  <input type="text" name="filename" value="{{ file }}" placeholder="FileName" id="input-filename" class="form-control"/>
                </div>
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-sm-1 col-form-label">Quantity</label>
              <div class="col-sm-11">
                  <div class="input-group">
                    <input type="number" name="qty" value="{{ qty }}" min="0" placeholder="Quantity" id="qty" class="form-control"/>
                  </div>
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-sm-1 col-form-label">Rate</label>
              <div class="col-sm-11">
                  <div class="input-group">
                    <input type="number" name="rate" value="{{ rate }}" min="0.00" step="0.01" placeholder="rate" id="rate" class="form-control"/>
                  </div>
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-sm-1 col-form-label">Amount</label>
              <div class="col-sm-11">
                  <div class="input-group">
                    <input type="number" name="amount" value="{{ amount }}" min="0.00" step="0.01" placeholder="Amount" id="amount" class="form-control"/>
                  </div>
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-sm-1 col-form-label">GST (in %)</label>
              <div class="col-sm-11">
                  <div class="input-group">
                    <input type="number" name="gst" value="{{ gst }}" min="0" placeholder="gst" id="gst" class="form-control"/>
                  </div>
              </div>
            </div>
            <div class="row mb-3">
              <label class="col-sm-1 col-form-label">Purchase Date</label>
              <div class="col-sm-11">
                  <div class="input-group">
                    <input type="date" name="purchase_date" value="{{ purchase_date }}" placeholder="Purchase Date" id="purchase_date" class="form-control date"/>
                  </div>
              </div>
            </div>
          <input type="hidden" name="purchase_id" value="{{ purchase_id }}" id="input-purchase-id"/>
        </form>
      </div>
    </div>
  </div>
</div>
{{ footer }}

<script>
$(document).ready(function() {
    $('#product_id').select2({
        width: '100%'
    });

    $('#input-vendor-class').select2({
        width: '100%'
    });
});


$('#button-upload').on('click', function () {
    var element = this;

    $('#form-upload').remove();

    $('body').prepend('<form enctype="multipart/form-data" id="form-upload" style="display: none;"><input type="file" name="file"/></form>');

    $('#form-upload input[name=\'file\']').trigger('click');

    $('#form-upload input[name=\'file\']').on('change', function () {
        if ((this.files[0].size / 1024) > 20000) {
            $(this).val('');

            alert('{{ error_upload_size }}');
        }
    });

    if (typeof timer !== 'undefined') {
        clearInterval(timer);
    }

    var timer = setInterval(function () {
        if ($('#form-upload input[name=\'file\']').val() !== '') {
            clearInterval(timer);

            $.ajax({
                url: 'index.php?route=catalog/purchase|upload&user_token={{ user_token }}',
                type: 'post',
                dataType: 'json',
                data: new FormData($('#form-upload')[0]),
                cache: false,
                contentType: false,
                processData: false,
                beforeSend: function () {
                    $(element).button('loading');
                },
                complete: function () {
                    $(element).button('reset');
                },
                success: function (json) {
                    if (json['error']) {
                        alert(json['error']);
                    }

                    if (json['success']) {
                        alert(json['success']);

                        $('#input-filename').val(json['filename']);
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                }
            });
        }
    }, 500);
});


</script>